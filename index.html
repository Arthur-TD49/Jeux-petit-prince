<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>La Course des Petits Princes - Ã‰dition Royale</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ‘‘</text></svg>" type="image/svg+xml">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #f9ca24, #f0932b, #eb4d4b, #6c5ce7);
      background-size: 400% 400%;
      animation: gradientShift 10s ease infinite;
      position: relative;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      25% { background-position: 100% 50%; }
      50% { background-position: 100% 100%; }
      75% { background-position: 0% 100%; }
      100% { background-position: 0% 50%; }
    }

    canvas {
      display: block;
      cursor: crosshair;
    }

    .overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(30,30,60,0.9));
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      z-index: 10;
      backdrop-filter: blur(10px);
    }

    #loginZone {
      background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(240,240,255,0.9));
      color: #333;
    }

    #startScreen, #endScreen, #hitMessage, #pauseScreen, #achievementPopup {
      display: none;
    }

    .level-up-message {
      font-size: 32px;
      color: #ffd700;
      font-weight: bold;
      margin: 20px 0;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
      animation: bounce 1s ease infinite;
    }

    #hitMessage {
      background: linear-gradient(135deg, rgba(255, 0, 0, 0.9), rgba(200, 0, 50, 0.8));
      animation: shake 0.5s ease-in-out;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    #pauseScreen {
      background: linear-gradient(135deg, rgba(0, 50, 100, 0.9), rgba(0, 100, 150, 0.8));
    }

    #loginZone input {
      display: block;
      margin: 15px auto;
      padding: 15px 20px;
      width: 90%;
      max-width: 350px;
      border-radius: 25px;
      border: 2px solid #ddd;
      font-size: 16px;
      transition: all 0.3s ease;
      background: rgba(255,255,255,0.9);
    }

    #loginZone input:focus {
      outline: none;
      border-color: #4ecdc4;
      box-shadow: 0 0 20px rgba(78, 205, 196, 0.3);
    }

    #msg {
      color: #e74c3c;
      margin-top: 15px;
      font-weight: bold;
    }

    .button {
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
      background-size: 300% 300%;
      color: white;
      border: none;
      padding: 15px 30px;
      margin: 10px;
      border-radius: 30px;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      transition: all 0.4s ease;
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
      position: relative;
      overflow: hidden;
      animation: buttonGradient 3s ease infinite;
    }

    @keyframes buttonGradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .button:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 12px 35px rgba(0,0,0,0.4);
      filter: brightness(1.2);
    }

    .button:active {
      transform: translateY(-1px) scale(1.02);
    }

    .button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.6s;
    }

    .button:hover::before {
      left: 100%;
    }

    #mobileControls {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 5;
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .control-btn {
      font-size: 20px;
      padding: 18px 28px;
      border: none;
      border-radius: 50px;
      background: linear-gradient(45deg, #ffc107, #ff9800, #ff5722);
      color: white;
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
      user-select: none;
    }

    .control-btn:active, .control-btn:hover {
      transform: scale(0.95);
      box-shadow: 0 4px 15px rgba(0,0,0,0.6);
    }

    .stats-panel {
      position: absolute;
      top: 15px;
      left: 15px;
      background: linear-gradient(135deg, rgba(0,0,0,0.8), rgba(50,50,100,0.8));
      color: white;
      padding: 20px;
      border-radius: 20px;
      font-size: 16px;
      z-index: 1;
      border: 2px solid rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      min-width: 200px;
    }

    .bonus-indicator {
      position: absolute;
      top: 15px;
      right: 15px;
      background: linear-gradient(135deg, rgba(255,215,0,0.9), rgba(255,140,0,0.8));
      color: white;
      padding: 15px 20px;
      border-radius: 20px;
      font-size: 14px;
      z-index: 1;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
      border: 2px solid rgba(255,255,255,0.3);
      animation: pulse 2s ease infinite;
    }

    .combo-indicator {
      position: absolute;
      top: 120px;
      right: 15px;
      background: linear-gradient(135deg, rgba(255,0,150,0.9), rgba(150,0,255,0.8));
      color: white;
      padding: 10px 15px;
      border-radius: 15px;
      font-size: 14px;
      z-index: 1;
      font-weight: bold;
      transform: scale(0);
      transition: transform 0.3s ease;
    }

    .combo-indicator.active {
      transform: scale(1);
      animation: comboFlash 0.5s ease;
    }

    @keyframes comboFlash {
      0%, 100% { background: linear-gradient(135deg, rgba(255,0,150,0.9), rgba(150,0,255,0.8)); }
      50% { background: linear-gradient(135deg, rgba(255,255,0,0.9), rgba(255,100,0,0.8)); }
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-15px); }
      60% { transform: translateY(-8px); }
    }

    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.9; }
      100% { transform: scale(1); opacity: 1; }
    }

    .progress-bar {
      position: absolute;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
      width: 300px;
      height: 20px;
      background: rgba(0,0,0,0.5);
      border-radius: 10px;
      overflow: hidden;
      z-index: 1;
      border: 2px solid rgba(255,255,255,0.3);
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1);
      border-radius: 8px;
      transition: width 0.3s ease;
      position: relative;
    }

    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: progressShine 2s linear infinite;
    }

    @keyframes progressShine {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .achievement {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: linear-gradient(135deg, #ffd700, #ffb347);
      color: #333;
      padding: 30px;
      border-radius: 20px;
      text-align: center;
      z-index: 100;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
      border: 3px solid #fff;
      max-width: 400px;
      animation: achievementPop 3s ease forwards;
    }

    @keyframes achievementPop {
      0% { transform: translate(-50%, -50%) scale(0) rotate(-180deg); }
      10% { transform: translate(-50%, -50%) scale(1.2) rotate(0deg); }
      20% { transform: translate(-50%, -50%) scale(0.9) rotate(0deg); }
      30% { transform: translate(-50%, -50%) scale(1) rotate(0deg); }
      90% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(0) rotate(180deg); opacity: 0; }
    }

    .star-field {
      position: absolute;
      width: 100%;
      height: 100%;
      overflow: hidden;
      z-index: -1;
    }

    .star {
      position: absolute;
      background: white;
      border-radius: 50%;
      opacity: 0.8;
      animation: twinkle 3s infinite;
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.3; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.2); }
    }

    .floating-score {
      position: absolute;
      font-size: 24px;
      font-weight: bold;
      color: #ffd700;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
      pointer-events: none;
      z-index: 3;
      animation: floatUp 2s ease-out forwards;
    }

    @keyframes floatUp {
      0% { transform: translateY(0) scale(1); opacity: 1; }
      100% { transform: translateY(-100px) scale(1.5); opacity: 0; }
    }

    .power-meter {
      position: absolute;
      top: 50%;
      left: 15px;
      transform: translateY(-50%);
      width: 30px;
      height: 200px;
      background: rgba(0,0,0,0.5);
      border-radius: 15px;
      z-index: 1;
      border: 2px solid rgba(255,255,255,0.3);
    }

    .power-fill {
      position: absolute;
      bottom: 0;
      width: 100%;
      background: linear-gradient(0deg, #ff0000, #ffff00, #00ff00);
      border-radius: 13px;
      transition: height 0.2s ease;
    }

    .weather-effect {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 2;
    }

    .rain-drop {
      position: absolute;
      background: linear-gradient(180deg, transparent, rgba(173,216,230,0.8));
      border-radius: 0 0 50% 50%;
      animation: fall linear infinite;
    }

    @keyframes fall {
      0% { transform: translateY(-100vh) rotate(10deg); }
      100% { transform: translateY(100vh) rotate(10deg); }
    }

    @media (max-width: 768px) {
      .stats-panel {
        font-size: 14px;
        padding: 15px;
        min-width: 180px;
      }
      
      .button {
        font-size: 16px;
        padding: 12px 24px;
      }
      
      #mobileControls {
        bottom: 20px;
        gap: 15px;
      }
      
      .control-btn {
        font-size: 18px;
        padding: 15px 25px;
      }
    }

    .particle-trail {
      position: absolute;
      pointer-events: none;
      z-index: 1;
    }
  </style>
</head>
<body>
  <div class="star-field" id="starField"></div>
  <div class="weather-effect" id="weatherEffect"></div>
  
  <canvas id="game"></canvas>
  
  <div class="stats-panel">
    <div style="font-size: 18px; margin-bottom: 10px; color: #ffd700;">ğŸ† Statistiques</div>
    <div>ğŸ’° Dons: <span id="scoreDisplay">0</span> â‚¬</div>
    <div>ğŸƒ Niveau: <span id="levelDisplay">1</span></div>
    <div>âš¡ Vitesse: <span id="speedDisplay">1.0</span>x</div>
    <div>ğŸ’– Vies: <span id="livesDisplay">3</span></div>
    <div>ğŸ”¥ Combo: <span id="comboDisplay">0</span></div>
    <div>â­ Points: <span id="pointsDisplay">0</span></div>
  </div>

  <div class="power-meter" id="powerMeter" style="display: none;">
    <div class="power-fill" id="powerFill"></div>
  </div>

  <div class="bonus-indicator" id="bonusIndicator" style="display: none;">
    <div id="bonusText">Bonus Actif!</div>
    <div id="bonusTimer">10s</div>
  </div>

  <div class="combo-indicator" id="comboIndicator">
    <div id="comboText">COMBO x2!</div>
  </div>

  <div class="progress-bar">
    <div class="progress-fill" id="progressFill"></div>
  </div>

    <div id="loginZone" class="overlay">
    <h2>ğŸŒŸ Bienvenue dans l'Ã‰dition Royale ğŸŒŸ</h2>
    <p>Rejoins l'aventure Ã©pique des Petits Princes ! ğŸš€</p>
    <div style="font-size: 60px; margin: 20px 0;">ğŸ‘‘âœ¨ğŸŒŸ</div>
    <input type="text" id="username" placeholder="Nom du Prince/Princesse">
    <input type="password" id="password" placeholder="Code secret">
    <button onclick="start()" class="button">ğŸš€ Commencer l'Aventure</button>
    <button onclick="register()" class="button">âœ¨ CrÃ©er un Royaume</button>
    <button onclick="quickStart()" class="button">âš¡ DÃ©marrage Rapide</button>
    <p id="msg"></p>
  </div>

  <div id="startScreen" class="overlay">
    <h1>ğŸŒŸ La Course des Petits Princes - Ã‰dition Royale ğŸƒâ€â™‚ï¸</h1>
    <p>Bonjour <span id="playerName" style="color: #ffd700; font-weight: bold;"></span> ! PrÃªt(e) pour une aventure magique ? âœ¨</p>
    <div style="font-size: 100px; margin: 30px 0; animation: bounce 2s infinite;">ğŸ‘‘ğŸŒŸâ­</div>
    
    <div style="background: rgba(255,255,255,0.1); padding: 25px; border-radius: 20px; margin: 25px; max-width: 500px;">
      <h3>ğŸ® Nouvelles FonctionnalitÃ©s Ã‰piques :</h3>
      <div style="text-align: left; margin: 15px 0;">
        <div>ğŸŒŸ SystÃ¨me de combo et multiplicateurs</div>
        <div>ğŸ¯ DÃ©fis et succÃ¨s Ã  dÃ©bloquer</div>
        <div>ğŸŒˆ Effets mÃ©tÃ©o dynamiques</div>
        <div>âš¡ Pouvoirs spÃ©ciaux et transformations</div>
        <div>ğŸ† Classements et progression</div>
        <div>ğŸ¨ Graphismes amÃ©liorÃ©s avec particules</div>
        <div>ğŸµ ExpÃ©rience immersive complÃ¨te</div>
      </div>
    </div>
    
    <button onclick="startGame()" class="button">ğŸš€ DÃ©marrer la QuÃªte Royale</button>
    <button onclick="showTutorial()" class="button">ğŸ“š Guide du Prince</button>
  </div>

  <div id="pauseScreen" class="overlay">
    <h2>â¸ï¸ Pause Royale</h2>
    <p>Le royaume t'attend, noble prince ! ğŸ°âœ¨</p>
    <div style="font-size: 80px; margin: 20px 0;">â±ï¸ğŸ‘‘</div>
    <button onclick="resumeGame()" class="button">â–¶ï¸ Reprendre la QuÃªte</button>
    <button onclick="restartGame()" class="button">ğŸ”„ Nouvelle Aventure</button>
    <button onclick="goToMenu()" class="button">ğŸ  Retour au ChÃ¢teau</button>
  </div>

  <div id="endScreen" class="overlay">
    <h1>ğŸ‰ Victoire Royale ! Un RÃªve Accompli ! ğŸŒŸ</h1>
    <div style="font-size: 80px; margin: 30px 0; animation: bounce 1s infinite;">ğŸ†ğŸ‘‘âœ¨</div>
    <div id="finalStats" style="background: rgba(255,255,255,0.15); padding: 30px; border-radius: 20px; margin: 30px; backdrop-filter: blur(10px);">
      <h3>ğŸ“Š Exploits Royaux Accomplis :</h3>
      <div style="font-size: 18px; margin: 10px 0;">
        <p>ğŸ’° Total des dons : <span id="finalScore" style="color: #ffd700;">0</span> â‚¬</p>
        <p>ğŸƒ Niveau royal atteint : <span id="finalLevel" style="color: #4ecdc4;">1</span></p>
        <p>â­ Bonus magiques : <span id="finalBonuses" style="color: #ff6b6b;">0</span></p>
        <p>ğŸ”¥ Meilleur combo : <span id="finalCombo" style="color: #f9ca24;">0</span></p>
        <p>ğŸ† Points de gloire : <span id="finalPoints" style="color: #e17055;">0</span></p>
      </div>
    </div>
    <a href="https://www.petitsprinces.com/" target="_blank" class="button">ğŸ’ Faire un Don VÃ©ritable</a>
    <button onclick="restartGame()" class="button">ğŸ”„ Nouvelle QuÃªte Royale</button>
    <button onclick="logout()" class="button">ğŸšª Retour au Monde</button>
  </div>

  <div id="hitMessage" class="overlay">
    <h2>ğŸ’¥ Oups ! Obstacle RencontrÃ© !</h2>
    <p>Courage, noble prince ! Il te reste <span id="remainingLives" style="color: #ffd700; font-size: 24px;"></span> vie(s) â¤ï¸</p>
    <div style="font-size: 60px; margin: 20px 0;">ğŸ˜…ğŸ›¡ï¸</div>
  </div>

  <div id="achievementPopup" class="achievement" style="display: none;">
    <h3 id="achievementTitle">ğŸ† Nouveau SuccÃ¨s !</h3>
    <p id="achievementDescription">Description du succÃ¨s</p>
    <div style="font-size: 40px; margin: 10px 0;" id="achievementIcon">â­</div>
  </div>

  <div id="mobileControls" style="display: none;">
    <button class="control-btn" id="jumpBtn" ontouchstart="jump()" onclick="jump()">ğŸ¦˜ Saut</button>
    <button class="control-btn" id="slideBtn" ontouchstart="slide()" onclick="slide()">ğŸƒ Glisse</button>
    <button class="control-btn" id="powerBtn" ontouchstart="usePower()" onclick="usePower()">âš¡ Pouvoir</button>
    <button class="control-btn" id="pauseBtn" onclick="togglePause()">â¸ï¸ Pause</button>
  </div>

  <script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      if (player.groundLevel) {
        player.groundLevel = canvas.height - 100;
      }
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // EmpÃªcher le dÃ©filement sur mobile
    document.body.addEventListener('touchmove', function(e) {
      e.preventDefault();
    }, { passive: false });

    // Variables globales amÃ©liorÃ©es
    let gameState = {
      player: {},
      keys: {},
      coins: [],
      obstacles: [],
      bonuses: [],
      particles: [],
      floatingScores: [],
      powerUps: [],
      weather: { type: 'clear', intensity: 0 },
      achievements: [],
      
      // Statistiques
      score: 0,
      level: 1,
      gameSpeed: 4,
      lives: 3,
      totalBonuses: 0,
      combo: 0,
      maxCombo: 0,
      points: 0,
      
      // Ã‰tat du jeu
      gameRunning: true,
      gamePaused: false,
      isSliding: false,
      powerCharge: 0,
      
      // Bonus actifs
      activeBonuses: { speed: 0, magnet: 0, shield: 0, fly: 0, giant: 0 },
      
      // Timers
      gravityTimer: null,
      weatherTimer: null,
      comboTimer: 0,
      
      // Effets visuels
      screenShake: 0,
      levelUpMessage: '',
      backgroundOffset: 0
    };

    // Ã‰lÃ©ments DOM
    const elements = {
      loginZone: document.getElementById('loginZone'),
      startScreen: document.getElementById('startScreen'),
      endScreen: document.getElementById('endScreen'),
      pauseScreen: document.getElementById('pauseScreen'),
      hitMessage: document.getElementById('hitMessage'),
      playerNameDisplay: document.getElementById('playerName'),
      bonusIndicator: document.getElementById('bonusIndicator'),
      comboIndicator: document.getElementById('comboIndicator'),
      achievementPopup: document.getElementById('achievementPopup'),
      progressFill: document.getElementById('progressFill'),
      powerMeter: document.getElementById('powerMeter'),
      powerFill: document.getElementById('powerFill')
    };

    // SystÃ¨me de succÃ¨s
    const achievements = [
      { id: 'first_coin', name: 'Premier TrÃ©sor', description: 'Collecte ta premiÃ¨re piÃ¨ce', icon: 'ğŸ’°', condition: () => gameState.score >= 1 },
      { id: 'combo_master', name: 'MaÃ®tre du Combo', description: 'Atteins un combo de 10', icon: 'ğŸ”¥', condition: () => gameState.maxCombo >= 10 },
      { id: 'level_5', name: 'Prince Aguerri', description: 'Atteins le niveau 5', icon: 'ğŸ‘‘', condition: () => gameState.level >= 5 },
      { id: 'collector', name: 'Collectionneur Royal', description: 'Collecte 25 bonus', icon: 'â­', condition: () => gameState.totalBonuses >= 25 },
      { id: 'survivor', name: 'Survivant LÃ©gendaire', description: 'Survit 2 minutes', icon: 'ğŸ›¡ï¸', condition: () => Date.now() - gameState.startTime > 120000 },
      { id: 'speed_demon', name: 'DÃ©mon de Vitesse', description: 'Atteins la vitesse 3x', icon: 'âš¡', condition: () => gameState.gameSpeed >= 12 },
      { id: 'point_master', name: 'MaÃ®tre des Points', description: 'Atteins 1000 points', icon: 'ğŸ†', condition: () => gameState.points >= 1000 }
    ];

    // Initialisation des Ã©toiles de fond
    function createStarField() {
      const starField = document.getElementById('starField');
      starField.innerHTML = '';
      
      for (let i = 0; i < 100; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 100 + '%';
        star.style.width = star.style.height = (Math.random() * 3 + 1) + 'px';
        star.style.animationDelay = Math.random() * 3 + 's';
        starField.appendChild(star);
      }
    }

    // SystÃ¨me mÃ©tÃ©o
    function updateWeather() {
      const weatherTypes = ['clear', 'rain', 'sparkle'];
      if (Math.random() < 0.01) { // 1% de chance de changement
        gameState.weather.type = weatherTypes[Math.floor(Math.random() * weatherTypes.length)];
        gameState.weather.intensity = Math.random() * 0.8 + 0.2;
        createWeatherEffects();
      }
    }

    function createWeatherEffects() {
      const weatherEffect = document.getElementById('weatherEffect');
      weatherEffect.innerHTML = '';
      
      if (gameState.weather.type === 'rain') {
        for (let i = 0; i < 20; i++) {
          const drop = document.createElement('div');
          drop.className = 'rain-drop';
          drop.style.left = Math.random() * 100 + '%';
          drop.style.width = '2px';
          drop.style.height = Math.random() * 20 + 10 + 'px';
          drop.style.animationDuration = (Math.random() * 1 + 0.5) + 's';
          drop.style.animationDelay = Math.random() * 2 + 's';
          weatherEffect.appendChild(drop);
        }
      }
    }

    // Fonctions d'authentification amÃ©liorÃ©es
    function login() {
      const user = document.getElementById('username').value.trim();
      const pass = document.getElementById('password').value;
      
      if (!user || !pass) {
        showMessage("âš ï¸ Veuillez remplir tous les champs, noble aventurier !", 'error');
        return;
      }
      
      const stored = JSON.parse(sessionStorage.getItem(user) || 'null');
      
      if (stored && stored.password === pass) {
        elements.loginZone.style.display = 'none';
        elements.startScreen.style.display = 'flex';
        elements.playerNameDisplay.innerText = user;
        showMessage("âœ¨ Bienvenue dans le royaume, " + user + " !", 'success');
        createStarField();
      } else {
        showMessage("âŒ Identifiants incorrects ! Essaie encore, brave aventurier !", 'error');
      }
    }

    function register() {
      const user = document.getElementById('username').value.trim();
      const pass = document.getElementById('password').value;
      
      if (!user || !pass) {
        showMessage("âš ï¸ Veuillez remplir tous les champs pour crÃ©er votre royaume !", 'error');
        return;
      }
      
      if (sessionStorage.getItem(user)) {
        showMessage("âš ï¸ Ce nom de royaume existe dÃ©jÃ  ! Choisis-en un autre.", 'error');
      } else {
        sessionStorage.setItem(user, JSON.stringify({ password: pass, bestScore: 0, achievements: [] }));
        showMessage("âœ… Royaume crÃ©Ã© avec succÃ¨s ! Tu peux maintenant te connecter.", 'success');
      }
    }

    function showMessage(text, type) {
      const msg = document.getElementById('msg');
      msg.innerText = text;
      msg.style.color = type === 'error' ? '#e74c3c' : '#27ae60';
      msg.style.animation = 'bounce 0.5s ease';
    }

    function quickStart() {
      // DÃ©marrage rapide sans authentification
      elements.loginZone.style.display = 'none';
      elements.startScreen.style.display = 'flex';
      elements.playerNameDisplay.innerText = 'Petit Prince';
      createStarField();
    }

    function logout() {
      location.reload();
    }

    function showTutorial() {
      alert(`ğŸ® GUIDE DU PETIT PRINCE ğŸ‘‘

ğŸ¯ OBJECTIF : Collecte 100â‚¬ de dons pour accomplir ton rÃªve !

ğŸ•¹ï¸ CONTRÃ”LES :
â€¢ ESPACE ou bouton SAUT : Sauter par-dessus les obstacles
â€¢ S ou bouton GLISSE : Glisser sous les obstacles
â€¢ P ou ESC : Mettre en pause
â€¢ E ou bouton POUVOIR : Utiliser ton pouvoir spÃ©cial

ğŸ’° OBJETS Ã€ COLLECTER :
â€¢ PiÃ¨ces dorÃ©es (1â‚¬) : Ressources de base
â€¢ Billets verts (10â‚¬) : Gros bonus !
â€¢ âš¡ Vitesse : Ralentit le temps
â€¢ ğŸ§² Aimant : Attire les piÃ¨ces
â€¢ ğŸ›¡ï¸ Bouclier : Protection temporaire
â€¢ ğŸ’– Vie : Vie supplÃ©mentaire
â€¢ ğŸš€ Vol : Permet de voler temporairement

ğŸ”¥ SYSTÃˆME DE COMBO :
Collecte des objets consÃ©cutivement pour multiplier tes points !

ğŸ† SUCCÃˆS Ã€ DÃ‰BLOQUER :
Accomplis des dÃ©fis pour gagner des titres royaux !

Bonne chance, noble prince ! ğŸŒŸ`);
    }

    // Gestion du jeu amÃ©liorÃ©e
    function startGame() {
      elements.startScreen.style.display = 'none';
      elements.pauseScreen.style.display = 'none';
      document.getElementById('mobileControls').style.display = 'flex';
      elements.powerMeter.style.display = 'block';
      initGame();
    }

    function togglePause() {
      if (gameState.gameRunning) {
        gameState.gamePaused = !gameState.gamePaused;
        if (gameState.gamePaused) {
          elements.pauseScreen.style.display = 'flex';
        } else {
          elements.pauseScreen.style.display = 'none';
        }
      }
    }

    function resumeGame() {
      gameState.gamePaused = false;
      elements.pauseScreen.style.display = 'none';
    }

    function restartGame() {
      elements.pauseScreen.style.display = 'none';
      elements.endScreen.style.display = 'none';
      elements.hitMessage.style.display = 'none';
      startGame();
    }

    function goToMenu() {
      location.reload();
    }

    // CrÃ©ation d'Ã©lÃ©ments de jeu amÃ©liorÃ©e
    function createCoin() {
      const groundLevel = canvas.height - 100;
      const maxJumpHeight = groundLevel - 150;
      const y = Math.random() * (groundLevel - maxJumpHeight) + maxJumpHeight;
      
      const coinType = Math.random();
      let type, value, width, height;
      
      if (coinType < 0.6) {
        type = 'coin';
        value = 1;
        width = height = 25;
      } else if (coinType < 0.9) {
        type = 'bill';
        value = 10;
        width = 40;
        height = 30;
      } else {
        type = 'diamond';
        value = 25;
        width = height = 30;
      }
      
      gameState.coins.push({ 
        x: canvas.width + 50, 
        y: y, 
        width: width, 
        height: height, 
        type: type, 
        value: value,
        collected: false,
        sparkles: [],
        rotation: 0,
        pulse: 0
      });
    }

    function createObstacle() {
      const height = Math.random() * 80 + 40;
      const groundLevel = canvas.height - 50;
      const obstacleTypes = ['spike', 'wall', 'pit'];
      const type = obstacleTypes[Math.floor(Math.random() * obstacleTypes.length)];
      
      gameState.obstacles.push({ 
        x: canvas.width + 50, 
        y: groundLevel - height, 
        width: type === 'pit' ? 60 : 40, 
        height: height,
        type: type,
        animation: 0
      });
    }

    function createBonus() {
      const bonusTypes = ['speed', 'magnet', 'shield', 'life', 'fly', 'giant'];
      const type = bonusTypes[Math.floor(Math.random() * bonusTypes.length)];
      
      const groundLevel = canvas.height - 100;
      const maxJumpHeight = groundLevel - 150;
      const y = Math.random() * (groundLevel - maxJumpHeight) + maxJumpHeight;
      
      gameState.bonuses.push({
        x: canvas.width + 50,
        y: y,
        width: 35,
        height: 35,
        type: type,
        rotation: 0,
        collected: false,
        pulse: 0
      });
    }

    function createParticle(x, y, color, count = 8) {
      for (let i = 0; i < count; i++) {
        gameState.particles.push({
          x: x,
          y: y,
          vx: (Math.random() - 0.5) * 8,
          vy: (Math.random() - 0.5) * 8,
          color: color || `hsl(${Math.random() * 360}, 70%, 60%)`,
          life: 40,
          maxLife: 40,
          size: Math.random() * 6 + 3,
          gravity: 0.1
        });
      }
    }

    function createFloatingScore(x, y, score) {
      gameState.floatingScores.push({
        x: x,
        y: y,
        score: score,
        life: 60,
        maxLife: 60
      });
    }

    // Fonctions de dessin amÃ©liorÃ©es
    function drawPlayer() {
      ctx.save();
      
      // Shake de l'Ã©cran
      if (gameState.screenShake > 0) {
        ctx.translate(
          (Math.random() - 0.5) * gameState.screenShake,
          (Math.random() - 0.5) * gameState.screenShake
        );
        gameState.screenShake *= 0.9;
      }
      
      const player = gameState.player;
      
      // Effet de bouclier
      if (gameState.activeBonuses.shield > 0) {
        ctx.strokeStyle = `hsl(${Date.now() * 0.5}, 70%, 60%)`;
        ctx.lineWidth = 6;
        ctx.beginPath();
        ctx.arc(player.x + player.width/2, player.y + player.height/2, 60, 0, Math.PI * 2);
        ctx.stroke();
      }
      
      // Effet de vitesse
      if (gameState.activeBonuses.speed > 0) {
        ctx.strokeStyle = 'rgba(255, 255, 0, 0.6)';
        ctx.lineWidth = 3;
        for (let i = 0; i < 3; i++) {
          ctx.beginPath();
          ctx.moveTo(player.x - i * 15, player.y + player.height/2);
          ctx.lineTo(player.x - i * 15 - 20, player.y + player.height/2);
          ctx.stroke();
        }
      }
      
      // Effet de vol
      if (gameState.activeBonuses.fly > 0) {
        ctx.fillStyle = 'rgba(135, 206, 235, 0.3)';
        ctx.beginPath();
        ctx.arc(player.x + player.width/2, player.y + player.height + 10, 20, 0, Math.PI * 2);
        ctx.fill();
      }
      
      // Effet gÃ©ant
      const scale = gameState.activeBonuses.giant > 0 ? 1.5 : 1;
      
      // Dessiner le personnage
      ctx.font = `${player.height * scale}px Arial`;
      ctx.textAlign = 'center';
      
      let emoji = 'ğŸ‘‘';
      if (gameState.isSliding) emoji = 'ğŸƒâ€â™‚ï¸';
      else if (!player.grounded) emoji = 'ğŸ¦…';
      else if (gameState.activeBonuses.giant > 0) emoji = 'ğŸ¤´';
      
      ctx.fillText(emoji, player.x + player.width/2, player.y + player.height);
      
      ctx.restore();
    }

    function drawCoins() {
      gameState.coins.forEach(coin => {
        ctx.save();
        ctx.translate(coin.x, coin.y);
        coin.rotation += 0.1;
        coin.pulse += 0.2;
        ctx.rotate(coin.rotation);
        
        const pulseScale = 1 + Math.sin(coin.pulse) * 0.1;
        ctx.scale(pulseScale, pulseScale);
        
        if (coin.type === 'coin') {
          // PiÃ¨ce dorÃ©e avec animation
          const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, coin.width/2);
          gradient.addColorStop(0, '#ffd700');
          gradient.addColorStop(0.5, '#ffed4a');
          gradient.addColorStop(1, '#f39c12');
          
          ctx.fillStyle = gradient;
          ctx.strokeStyle = '#e67e22';
          ctx.lineWidth = 3;
          ctx.beginPath();
          ctx.arc(0, 0, coin.width / 2, 0, Math.PI * 2);
          ctx.fill();
          ctx.stroke();
          
          ctx.fillStyle = '#8b4513';
          ctx.font = 'bold 14px Arial';
          ctx.textAlign = 'center';
          ctx.fillText('â‚¬', 0, 5);
        } else if (coin.type === 'bill') {
          // Billet vert amÃ©liorÃ©
          const gradient = ctx.createLinearGradient(-coin.width/2, 0, coin.width/2, 0);
          gradient.addColorStop(0, '#27ae60');
          gradient.addColorStop(0.5, '#2ecc71');
          gradient.addColorStop(1, '#16a085');
          
          ctx.fillStyle = gradient;
          ctx.fillRect(-coin.width/2, -coin.height/2, coin.width, coin.height);
          
          ctx.strokeStyle = '#1e8449';
          ctx.lineWidth = 3;
          ctx.strokeRect(-coin.width/2, -coin.height/2, coin.width, coin.height);
          
          ctx.fillStyle = 'white';
          ctx.font = 'bold 12px Arial';
          ctx.textAlign = 'center';
          ctx.fillText('10â‚¬', 0, 3);
        } else if (coin.type === 'diamond') {
          // Diamant arc-en-ciel
          const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, coin.width/2);
          gradient.addColorStop(0, '#ff6b6b');
          gradient.addColorStop(0.3, '#4ecdc4');
          gradient.addColorStop(0.6, '#45b7d1');
          gradient.addColorStop(1, '#f9ca24');
          
          ctx.fillStyle = gradient;
          ctx.beginPath();
          ctx.moveTo(0, -coin.height/2);
          ctx.lineTo(coin.width/3, 0);
          ctx.lineTo(0, coin.height/2);
          ctx.lineTo(-coin.width/3, 0);
          ctx.closePath();
          ctx.fill();
          
          ctx.strokeStyle = 'white';
          ctx.lineWidth = 2;
          ctx.stroke();
        }
        
        ctx.restore();
      });
    }

    function drawObstacles() {
      gameState.obstacles.forEach(obs => {
        ctx.save();
        obs.animation += 0.1;
        
        if (obs.type === 'spike') {
          // Obstacle Ã©pineux animÃ©
          const gradient = ctx.createLinearGradient(obs.x, obs.y, obs.x, obs.y + obs.height);
          gradient.addColorStop(0, '#e74c3c');
          gradient.addColorStop(0.5, '#c0392b');
          gradient.addColorStop(1, '#8b0000');
          
          ctx.fillStyle = gradient;
          ctx.fillRect(obs.x, obs.y, obs.width, obs.height);
          
          // Ã‰pines animÃ©es
          ctx.fillStyle = '#a93226';
          for (let i = 0; i < obs.width; i += 12) {
            const spikeHeight = 12 + Math.sin(obs.animation + i * 0.1) * 3;
            ctx.beginPath();
            ctx.moveTo(obs.x + i, obs.y);
            ctx.lineTo(obs.x + i + 6, obs.y - spikeHeight);
            ctx.lineTo(obs.x + i + 12, obs.y);
            ctx.fill();
          }
        } else if (obs.type === 'wall') {
          // Mur de briques
          ctx.fillStyle = '#7f8c8d';
          ctx.fillRect(obs.x, obs.y, obs.width, obs.height);
          
          ctx.strokeStyle = '#2c3e50';
          ctx.lineWidth = 2;
          for (let i = 0; i < obs.height; i += 15) {
            ctx.beginPath();
            ctx.moveTo(obs.x, obs.y + i);
            ctx.lineTo(obs.x + obs.width, obs.y + i);
            ctx.stroke();
          }
        } else if (obs.type === 'pit') {
          // Fosse
          ctx.fillStyle = '#2c3e50';
          ctx.fillRect(obs.x, obs.y + obs.height - 10, obs.width, 10);
          
          // Effets de danger
          ctx.fillStyle = '#e74c3c';
          for (let i = 0; i < 5; i++) {
            const x = obs.x + i * (obs.width / 5);
            const flicker = Math.sin(obs.animation * 3 + i) * 0.3 + 0.7;
            ctx.globalAlpha = flicker;
            ctx.fillRect(x, obs.y + obs.height - 8, 8, 4);
          }
          ctx.globalAlpha = 1;
        }
        
        ctx.restore();
      });
    }

    function drawBonuses() {
      gameState.bonuses.forEach(bonus => {
        ctx.save();
        ctx.translate(bonus.x, bonus.y);
        bonus.rotation += 0.15;
        bonus.pulse += 0.3;
        
        ctx.rotate(bonus.rotation);
        
        const pulseScale = 1 + Math.sin(bonus.pulse) * 0.2;
        ctx.scale(pulseScale, pulseScale);
        
        // Aura brillante
        ctx.shadowColor = getBonusColor(bonus.type);
        ctx.shadowBlur = 20;
        
        const emoji = getBonusEmoji(bonus.type);
        ctx.font = '30px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(emoji, 0, 10);
        
        ctx.restore();
      });
    }

    function getBonusEmoji(type) {
      const emojis = {
        speed: 'âš¡',
        magnet: 'ğŸ§²',
        shield: 'ğŸ›¡ï¸',
        life: 'ğŸ’–',
        fly: 'ğŸš€',
        giant: 'â­'
      };
      return emojis[type] || 'â­';
    }

    function getBonusColor(type) {
      const colors = {
        speed: '#f1c40f',
        magnet: '#e74c3c',
        shield: '#3498db',
        life: '#e91e63',
        fly: '#9b59b6',
        giant: '#f39c12'
      };
      return colors[type] || '#ffffff';
    }

    function drawParticles() {
      gameState.particles.forEach(particle => {
        ctx.save();
        ctx.globalAlpha = particle.life / particle.maxLife;
        ctx.fillStyle = particle.color;
        ctx.beginPath();
        ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
      });
    }

    function drawFloatingScores() {
      gameState.floatingScores.forEach(floatingScore => {
        ctx.save();
        ctx.globalAlpha = floatingScore.life / floatingScore.maxLife;
        ctx.font = 'bold 24px Arial';
        ctx.fillStyle = '#ffd700';
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 3;
        ctx.textAlign = 'center';
        
        const y = floatingScore.y - (floatingScore.maxLife - floatingScore.life) * 2;
        ctx.strokeText(`+${floatingScore.score}â‚¬`, floatingScore.x, y);
        ctx.fillText(`+${floatingScore.score}â‚¬`, floatingScore.x, y);
        
        ctx.restore();
      });
    }

    function updateUI() {
      document.getElementById('scoreDisplay').innerText = gameState.score;
      document.getElementById('levelDisplay').innerText = gameState.level;
      document.getElementById('speedDisplay').innerText = (gameState.gameSpeed / 4).toFixed(1);
      document.getElementById('livesDisplay').innerText = gameState.lives;
      document.getElementById('comboDisplay').innerText = gameState.combo;
      document.getElementById('pointsDisplay').innerText = gameState.points;
      
      // Barre de progression
      const progress = Math.min(gameState.score / 100, 1) * 100;
      elements.progressFill.style.width = progress + '%';
      
      // Indicateur de pouvoir
      elements.powerFill.style.height = (gameState.powerCharge / 100) * 100 + '%';
      
      // Indicateur de bonus
      const activeBonus = Object.keys(gameState.activeBonuses).find(key => gameState.activeBonuses[key] > 0);
      if (activeBonus) {
        elements.bonusIndicator.style.display = 'block';
        const bonusNames = {
          speed: 'âš¡ Temps Ralenti',
          magnet: 'ğŸ§² Super Aimant',
          shield: 'ğŸ›¡ï¸ Bouclier Magique',
          fly: 'ğŸš€ Vol Libre',
          giant: 'â­ Mode GÃ©ant'
        };
        document.getElementById('bonusText').innerText = bonusNames[activeBonus];
        document.getElementById('bonusTimer').innerText = Math.ceil(gameState.activeBonuses[activeBonus] / 60) + 's';
      } else {
        elements.bonusIndicator.style.display = 'none';
      }
      
      // Indicateur de combo
      if (gameState.combo >= 2) {
        elements.comboIndicator.classList.add('active');
        document.getElementById('comboText').innerText = `COMBO x${gameState.combo}!`;
      } else {
        elements.comboIndicator.classList.remove('active');
      }
    }

    function showAchievement(achievement) {
      elements.achievementPopup.style.display = 'block';
      document.getElementById('achievementTitle').innerText = achievement.name;
      document.getElementById('achievementDescription').innerText = achievement.description;
      document.getElementById('achievementIcon').innerText = achievement.icon;
      
      setTimeout(() => {
        elements.achievementPopup.style.display = 'none';
      }, 3000);
    }

    function checkAchievements() {
      achievements.forEach(achievement => {
        if (!gameState.achievements.includes(achievement.id) && achievement.condition()) {
          gameState.achievements.push(achievement.id);
          showAchievement(achievement);
          gameState.points += 100;
        }
      });
    }

    function drawLevelUpMessage() {
      if (gameState.levelUpMessage) {
        ctx.save();
        ctx.font = 'bold 48px Arial';
        ctx.textAlign = 'center';
        
        // Effet arc-en-ciel
        const gradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
        gradient.addColorStop(0, '#ff6b6b');
        gradient.addColorStop(0.2, '#4ecdc4');
        gradient.addColorStop(0.4, '#45b7d1');
        gradient.addColorStop(0.6, '#f9ca24');
        gradient.addColorStop(0.8, '#f0932b');
        gradient.addColorStop(1, '#eb4d4b');
        
        ctx.fillStyle = gradient;
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 4;
        
        ctx.strokeText(gameState.levelUpMessage, canvas.width / 2, canvas.height / 2);
        ctx.fillText(gameState.levelUpMessage, canvas.width / 2, canvas.height / 2);
        
        ctx.restore();
      }
    }

    // ContrÃ´les amÃ©liorÃ©s
    function jump() {
      if (gameState.player.grounded && gameState.gameRunning && !gameState.gamePaused) {
        gameState.player.dy = gameState.player.jumpForce;
        gameState.player.grounded = false;
        createParticle(gameState.player.x, gameState.player.y + gameState.player.height, '#4ecdc4', 3);
      }
    }

    function slide() {
      if (gameState.player.grounded && gameState.gameRunning && !gameState.gamePaused) {
        gameState.isSliding = true;
        setTimeout(() => {
          gameState.isSliding = false;
        }, 800);
      }
    }

    function usePower() {
      if (gameState.powerCharge >= 100 && gameState.gameRunning && !gameState.gamePaused) {
        gameState.powerCharge = 0;
        
        // Destruction d'obstacles
        gameState.obstacles = gameState.obstacles.filter(obs => {
          if (obs.x < canvas.width) {
            createParticle(obs.x + obs.width/2, obs.y + obs.height/2, '#e74c3c', 10);
            return false;
          }
          return true;
        });
        
        // Effet visuel
        gameState.screenShake = 20;
        createParticle(gameState.player.x, gameState.player.y, '#ffd700', 20);
      }
    }

    function initGame() {
      const groundLevel = canvas.height - 100;
      
      gameState = {
        ...gameState,
        player: { 
          x: 100, 
          y: groundLevel, 
          width: 50, 
          height: 60, 
          dy: 0, 
          gravity: 0.8, 
          jumpForce: -16, 
          grounded: true,
          groundLevel: groundLevel
        },
        coins: [],
        obstacles: [],
        bonuses: [],
        particles: [],
        floatingScores: [],
        score: 0,
        level: 1,
        gameSpeed: 4,
        lives: 3,
        totalBonuses: 0,
        combo: 0,
        maxCombo: 0,
        points: 0,
        powerCharge: 0,
        isSliding: false,
        gameRunning: true,
        gamePaused: false,
        activeBonuses: { speed: 0, magnet: 0, shield: 0, fly: 0, giant: 0 },
        screenShake: 0,
        levelUpMessage: '',
        backgroundOffset: 0,
        comboTimer: 0,
        startTime: Date.now(),
        achievements: []
      };
      
      clearInterval(gameState.gravityTimer);
      clearInterval(gameState.weatherTimer);
      
      gameState.gravityTimer = setInterval(() => { 
        if (!gameState.gamePaused) {
          gameState.gameSpeed += 0.2;
          gameState.powerCharge = Math.min(gameState.powerCharge + 2, 100);
        }
      }, 3000);
      
      gameState.weatherTimer = setInterval(updateWeather, 5000);
      
      createStarField();
      createWeatherEffects();
      gameLoop();
    }

    // ContrÃ´les clavier
    window.addEventListener('keydown', (e) => {
      gameState.keys[e.key] = true;
      
      if (e.key === ' ') {
        e.preventDefault();
        jump();
      } else if (e.key === 's' || e.key === 'S') {
        e.preventDefault();
        slide();
      } else if (e.key === 'e' || e.key === 'E') {
        e.preventDefault();
        usePower();
      } else if (e.key === 'Escape' || e.key === 'p' || e.key === 'P') {
        togglePause();
      }
    });
    
    window.addEventListener('keyup', (e) => {
      gameState.keys[e.key] = false;
    });

    function gameLoop() {
      if (!gameState.gameRunning) return;
      if (!gameState.gamePaused) {
        update();
      }
      draw();
      requestAnimationFrame(gameLoop);
    }

    function update() {
      // VÃ©rification de victoire
      if (gameState.score >= 100) {
        gameState.gameRunning = false;
        clearInterval(gameState.gravityTimer);
        clearInterval(gameState.weatherTimer);
        
        // Statistiques finales
        document.getElementById('finalScore').innerText = gameState.score;
        document.getElementById('finalLevel').innerText = gameState.level;
        document.getElementById('finalBonuses').innerText = gameState.totalBonuses;
        document.getElementById('finalCombo').innerText = gameState.maxCombo;
        document.getElementById('finalPoints').innerText = gameState.points;
        
        elements.endScreen.style.display = 'flex';
        return;
      }

      const player = gameState.player;
      
      // Physique du joueur
      if (!gameState.activeBonuses.fly > 0) {
        player.dy += player.gravity;
      }
      
      player.y += player.dy;

      if (player.y >= player.groundLevel) {
        player.y = player.groundLevel;
        player.dy = 0;
        player.grounded = true;
      } else {
        player.grounded = false;
      }

      // Vol actif
      if (gameState.activeBonuses.fly > 0) {
        player.dy *= 0.8; // RÃ©duction de la gravitÃ©
        if (gameState.keys[' ']) {
          player.dy = Math.max(player.dy - 1, -10);
        }
      }

      // GÃ©nÃ©ration d'Ã©lÃ©ments
      if (Math.random() < 0.03) createCoin();
      if (Math.random() < 0.01 + gameState.level * 0.001) createObstacle();
      if (Math.random() < 0.004) createBonus();

      // Mise Ã  jour des bonus
      Object.keys(gameState.activeBonuses).forEach(key => {
        if (gameState.activeBonuses[key] > 0) {
          gameState.activeBonuses[key]--;
        }
      });

      // Timer de combo
      if (gameState.comboTimer > 0) {
        gameState.comboTimer--;
      } else if (gameState.combo > 0) {
        gameState.combo = 0;
      }

      // Vitesse effective
      let effectiveSpeed = gameState.gameSpeed;
      if (gameState.activeBonuses.speed > 0) {
        effectiveSpeed *= 0.6;
      }

      // Effet aimant
      if (gameState.activeBonuses.magnet > 0) {
        gameState.coins.forEach(coin => {
          const dx = (player.x + player.width/2) - coin.x;
          const dy = (player.y + player.height/2) - coin.y;
          const distance = Math.sqrt(dx*dx + dy*dy);
          
          if (distance < 120) {
            coin.x += dx * 0.08;
            coin.y += dy * 0.08;
          }
        });
      }

      // Mise Ã  jour des piÃ¨ces
      for (let i = gameState.coins.length - 1; i >= 0; i--) {
        const coin = gameState.coins[i];
        coin.x -= effectiveSpeed;
        
        // Collision
        const playerWidth = gameState.activeBonuses.giant > 0 ? player.width * 1.5 : player.width;
        const playerHeight = gameState.activeBonuses.giant > 0 ? player.height * 1.5 : player.height;
        
        if (
          player.x < coin.x + coin.width/2 &&
          player.x + playerWidth > coin.x - coin.width/2 &&
          player.y < coin.y + coin.height/2 &&
          player.y + playerHeight > coin.y - coin.height/2
        ) {
          gameState.score += coin.value * (gameState.combo + 1);
          gameState.points += coin.value * 2 * (gameState.combo + 1);
          gameState.combo++;
          gameState.maxCombo = Math.max(gameState.maxCombo, gameState.combo);
          gameState.comboTimer = 180; // 3 secondes
          
          createParticle(coin.x, coin.y, '#ffd700', 8);
          createFloatingScore(coin.x, coin.y, coin.value * (gameState.combo));
          
          gameState.coins.splice(i, 1);
          continue;
        }
        
        if (coin.x < -100) {
          gameState.coins.splice(i, 1);
        }
      }

      // Mise Ã  jour des obstacles
      for (let i = gameState.obstacles.length - 1; i >= 0; i--) {
        const obs = gameState.obstacles[i];
        obs.x -= effectiveSpeed;
        
        // Collision (sauf si bouclier actif ou en vol)
        const playerWidth = gameState.activeBonuses.giant > 0 ? player.width * 1.5 : player.width;
        const playerHeight = gameState.isSliding ? player.height * 0.5 : 
                          (gameState.activeBonuses.giant > 0 ? player.height * 1.5 : player.height);
        const playerY = gameState.isSliding ? player.y + player.height * 0.25 : player.y;
        
        if (
          gameState.activeBonuses.shield === 0 &&
          gameState.activeBonuses.fly === 0 &&
          player.x < obs.x + obs.width &&
          player.x + playerWidth > obs.x &&
          playerY < obs.y + obs.height &&
          playerY + playerHeight > obs.y
        ) {
          gameState.lives--;
          gameState.combo = 0;
          gameState.screenShake = 15;
          createParticle(obs.x, obs.y, '#e74c3c', 12);
          
          document.getElementById('remainingLives').innerText = gameState.lives;
          elements.hitMessage.style.display = 'flex';
          setTimeout(() => {
            elements.hitMessage.style.display = 'none';
          }, 1500);
          
          if (gameState.lives <= 0) {
            gameState.gameRunning = false;
            clearInterval(gameState.gravityTimer);
            clearInterval(gameState.weatherTimer);
            
            document.getElementById('finalScore').innerText = gameState.score;
            document.getElementById('finalLevel').innerText = gameState.level;
            document.getElementById('finalBonuses').innerText = gameState.totalBonuses;
            document.getElementById('finalCombo').innerText = gameState.maxCombo;
            document.getElementById('finalPoints').innerText = gameState.points;
            
            elements.endScreen.style.display = 'flex';
            return;
          }
          
          gameState.obstacles.splice(i, 1);
          continue;
        }
        
        if (obs.x < -100) {
          gameState.obstacles.splice(i, 1);
        }
      }

      // Mise Ã  jour des bonus
      for (let i = gameState.bonuses.length - 1; i >= 0; i--) {
        const bonus = gameState.bonuses[i];
        bonus.x -= effectiveSpeed;
        
        // Collision
        const playerWidth = gameState.activeBonuses.giant > 0 ? player.width * 1.5 : player.width;
        const playerHeight = gameState.activeBonuses.giant > 0 ? player.height * 1.5 : player.height;
        
        if (
          player.x < bonus.x + bonus.width &&
          player.x + playerWidth > bonus.x &&
          player.y < bonus.y + bonus.height &&
          player.y + playerHeight > bonus.y
        ) {
          gameState.totalBonuses++;
          gameState.points += 50;
          createParticle(bonus.x, bonus.y, getBonusColor(bonus.type), 15);
          
          switch (bonus.type) {
            case 'speed':
              gameState.activeBonuses.speed = 600; // 10 secondes
              break;
            case 'magnet':
              gameState.activeBonuses.magnet = 900; // 15 secondes
              break;
            case 'shield':
              gameState.activeBonuses.shield = 480; // 8 secondes
              break;
            case 'life':
              gameState.lives = Math.min(gameState.lives + 1, 5);
              break;
            case 'fly':
              gameState.activeBonuses.fly = 720; // 12 secondes
              break;
            case 'giant':
              gameState.activeBonuses.giant = 540; // 9 secondes
              break;
          }
          
          gameState.bonuses.splice(i, 1);
          continue;
        }
        
        if (bonus.x < -100) {
          gameState.bonuses.splice(i, 1);
        }
      }

      // Mise Ã  jour des particules
      for (let i = gameState.particles.length - 1; i >= 0; i--) {
        const particle = gameState.particles[i];
        particle.x += particle.vx;
        particle.y += particle.vy;
        particle.vy += particle.gravity;
        particle.life--;
        particle.vx *= 0.98;
        
        if (particle.life <= 0) {
          gameState.particles.splice(i, 1);
        }
      }

      // Mise Ã  jour des scores flottants
      for (let i = gameState.floatingScores.length - 1; i >= 0; i--) {
        gameState.floatingScores[i].life--;
        if (gameState.floatingScores[i].life <= 0) {
          gameState.floatingScores.splice(i, 1);
        }
      }

      // Mise Ã  jour du niveau
      const newLevel = Math.floor(gameState.score / 12) + 1;
      if (newLevel > gameState.level) {
        gameState.level = newLevel;
        gameState.levelUpMessage = `ğŸ‰ Niveau ${gameState.level} - Nouveau Royaume DÃ©bloquÃ©! ğŸ°`;
        gameState.points += 200;
        setTimeout(() => {
          gameState.levelUpMessage = '';
        }, 3000);
      }

      // VÃ©rifier les succÃ¨s
      checkAchievements();

      // Mettre Ã  jour l'interface
      updateUI();
    }

    function draw() {
      // Fond animÃ©
      gameState.backgroundOffset += 0.5;
      const gradient = ctx.createLinearGradient(0, 0, canvas.width + gameState.backgroundOffset, canvas.height);
      gradient.addColorStop(0, '#87ceeb');
      gradient.addColorStop(0.3, '#98fb98');
      gradient.addColorStop(0.6, '#f0e68c');
      gradient.addColorStop(1, '#dda0dd');
      
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Nuages dÃ©coratifs
      ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
      for (let i = 0; i < 5; i++) {
        const x = (gameState.backgroundOffset * 0.3 + i * 200) % (canvas.width + 100);
        const y = 50 + Math.sin(Date.now() * 0.001 + i) * 20;
        ctx.beginPath();
        ctx.arc(x, y, 30, 0, Math.PI * 2);
        ctx.arc(x + 25, y, 35, 0, Math.PI * 2);
        ctx.arc(x + 50, y, 30, 0, Math.PI * 2);
        ctx.fill();
      }
      
      // Sol dÃ©coratif
      const groundGradient = ctx.createLinearGradient(0, canvas.height - 100, 0, canvas.height);
      groundGradient.addColorStop(0, '#2ecc71');
      groundGradient.addColorStop(1, '#27ae60');
      ctx.fillStyle = groundGradient;
      ctx.fillRect(0, canvas.height - 100, canvas.width, 100);
      
      // Herbe
      ctx.fillStyle = '#229954';
      for (let i = 0; i < canvas.width; i += 20) {
        const x = i + (gameState.backgroundOffset % 20);
        ctx.fillRect(x, canvas.height - 100, 3, -10 - Math.sin(Date.now() * 0.005 + i * 0.1) * 5);
      }
      
      // Dessiner tous les Ã©lÃ©ments
      drawParticles();
      drawCoins();
      drawObstacles();
      drawBonuses();
      drawPlayer();
      drawFloatingScores();
      drawLevelUpMessage();
      
      // Effets spÃ©ciaux
      if (gameState.activeBonuses.speed > 0) {
        ctx.fillStyle = 'rgba(255, 255, 0, 0.1)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }
    }

    // Rendre les fonctions accessibles globalement
    window.login = login;
    window.register = register;
    window.quickStart = quickStart;
    window.startGame = startGame;
    window.showTutorial = showTutorial;
    window.togglePause = togglePause;
    window.resumeGame = resumeGame;
    window.restartGame = restartGame;
    window.goToMenu = goToMenu;
    window.logout = logout;
    window.jump = jump;
    window.slide = slide;
    window.usePower = usePower;

    // Initialisation
    createStarField();
    
    // EmpÃªcher le zoom sur mobile
    document.addEventListener('gesturestart', function (e) {
      e.preventDefault();
    });

    document.addEventListener('gesturechange', function (e) {
      e.preventDefault();
    });

    document.addEventListener('gestureend', function (e) {
      e.preventDefault();
    });
  </script>
</body>
</html>
